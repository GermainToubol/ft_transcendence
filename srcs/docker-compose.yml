# **************************************************************************** #
#                                                                              #
#                                                         :::      ::::::::    #
#    docker-compose.yml                                 :+:      :+:    :+:    #
#                                                     +:+ +:+         +:+      #
#    By: gtoubol <marvin@42.fr>                     +#+  +:+       +#+         #
#                                                 +#+#+#+#+#+   +#+            #
#    Created: 2022/12/13 09:12:15 by gtoubol           #+#    #+#              #
#    Updated: 2022/12/13 09:12:15 by gtoubol          ###   ########.fr        #
#                                                                              #
# **************************************************************************** #

# Volumes
# ------------------------------------------------------------------------
volumes:
  front_data:
    name: front_data
    driver: local
    driver_opts:
      type: none
      o: bind
      device: "${TR_FRONT_SRCS}"

  # --------------------------
  back_data:
    name: back_data
    driver: local
    driver_opts:
      type: none
      o: bind
      device: "${TR_BACK_SRCS}"

  # --------------------------
  db_data: {}

# Networks
# ------------------------------------------------------------------------
networks:
  backend-net:
    name: "backend-net"
    driver: "bridge"


# Servicies
# ------------------------------------------------------------------------
services:
  frontend:
    container_name: frontend
    build: ./frontend
    ports:
      - "3500:3500"
    volumes:
      - "front_data:/root/srcs"
    networks:
      - backend-net

  # --------------------------
  backend:
    container_name: backend
    build: ./backend
    ports:
      - 3000:3000
    volumes:
      - "back_data:/root/srcs"
    networks:
      - backend-net
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost:3000"]
    environment:
      - DOMAIN=${DOMAIN}
      - API_UID=${API_UID}
      - API_SECRET=${API_SECRET}
      - JWT_SECRET=${JWT_SECRET}
      - DB_USER=${POSTGRES_USER}
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      - DB_NAME=${POSTGRES_USER}
      - TWO_FACTOR_AUTHENTICATION_APP_NAME=${TWO_FACTOR_AUTHENTICATION_APP_NAME}

  # --------------------------
  database:
    container_name: "database"
    image: postgres:alpine
    restart: always
    networks:
      - backend-net
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      PGDATA: ${PGDATA}
    volumes:
      - db_data:/var/lib/postgresql/data

  # --------------------------
  adminer:
    image: adminer
    restart: always
    ports:
      - 8080:8080
    networks:
      - backend-net
